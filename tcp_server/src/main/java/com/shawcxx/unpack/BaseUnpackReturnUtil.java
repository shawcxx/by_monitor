package com.shawcxx.unpack;

import cn.hutool.core.util.HexUtil;
import cn.hutool.core.util.StrUtil;

/**
 * @author Chen jl
 * @date 2022/6/19 21:19
 * @description
 **/
public class BaseUnpackReturnUtil {
    public static String getUnpackReturnData(String CMD, String deviceId, String... args) {
        int length = 0;
        //起始字符
        String protocol = "68";
        length++;

        //数据域长
        length += 2;

        //起始字符
        String protocol2 = "68";
        length++;

        //控制码
        length += 2;

        //采集器ID
        length += 4;
        String id = StrUtil.padPre(Long.parseLong(deviceId, 16) + "", 8, '0');

        //预留
        length += 4;
        String reverse = "00000000";

        StringBuilder data = new StringBuilder();
        for (String arg : args) {
            length += arg.length();
            data.append(arg);
        }

        //cs
        length++;

        //end
        length++;

        String pre = protocol + StrUtil.padPre(HexUtil.toHex(length), 4, '0') + protocol2 + CMD + id + reverse + data.toString();

        String cs = getCheckSum(pre);

        String end = "16";

        return pre + cs + end;
    }


    private static String getCheckSum(String pre) {
        long total = 0;
        for (String s : StrUtil.split(pre, 2)) {
            long i = Long.parseLong(s, 16);

            total += i;

        }
        total += 85;
        /**
         * 用256求余最大是255，即16进制的FF
         */
        int mod = (int) (total % 256);
        String hex = StrUtil.padPre(Integer.toHexString(mod), 2, '0').toUpperCase();
        return hex;
    }

    public static void main(String[] args) {
        //A5
        String data = "6803D66810049099912100000000F71F0B0E221111860033010B4D22450C0009E2C038733AE2320900000000000000000000000011860034010B4D2A44FF000B812C34993A79320C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009916";
        System.out.println(getCheckSum(data));
    }
}
